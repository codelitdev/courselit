---
    - hosts: all
      become: true

      tasks:
        - name: Check previous installation
          stat:
            path: $HOME/docker/.env
          register: previous_install

        # Ask user if she wants to use existing installation
        - pause:
            prompt: "Previous installation detected. Would you like to use the existing settings? [yes/no]"
          register: prompt
          when: previous_install.stat.exists

        - set_fact:
            use_existing_installation: "{{ true if prompt.user_input|bool else false }}"
          when: previous_install.stat.exists

        - set_fact:
            use_existing_installation: false
          when: not previous_install.stat.exists

        - include_role:
            name: install_softwares
          when: not use_existing_installation

        # Ask user if she wants to setup SSL
        - pause:
            prompt: "Would you like to enable SSL? [yes/no]"
          register: prompt
          when: not use_existing_installation
        - set_fact:
            enable_ssl: "{{ true if prompt.user_input|bool else false }}"
          when: not use_existing_installation

        - pause:
            prompt: "Make sure that the domain propagation is complete. It is required to acquire a SSL certificate from Let's Encrypt. Press Enter to continue."
          when: enable_ssl

        # Collect user's domain name or IP address
        - pause:
            prompt: "Enter your domain name (FQDN)."
          register: prompt
          when: not use_existing_installation and enable_ssl

        - set_fact:
            domain: "{{ prompt.user_input }}"
          when: not use_existing_installation and enable_ssl

        - pause:
            prompt: "Enter your domain name or IP address."
          register: prompt
          when: not use_existing_installation and not enable_ssl
        
        - set_fact:
            domain: "{{ prompt.user_input }}"
          when: not use_existing_installation and not enable_ssl

        - name: Set up SSL certificate
          include_role:
            name: letsencrypt
          when: not use_existing_installation and enable_ssl

        - include_role:
            name: setup_docker
          when: not use_existing_installation